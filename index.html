<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>pipe.spacet.me</title>
  </head>
  <body>
    <h1>pipe.spacet.me</h1>
    <div data-controller="pipe">
      <div data-pipe-target="status"></div>
      <form data-action="pipe#send" data-pipe-target="form">
        <textarea name="message"></textarea>
        <input type="submit" value="Send to other peers" />
      </form>
      <h2>Inbox</h2>
      <ul data-pipe-target="inbox"></ul>
    </div>
    <script
      src="https://cdn.jsdelivr.net/npm/p2pkit@0.0.0-2/dist/index.js"
      integrity="sha256-IBqKNNdZBkvlyBDTBnPO57idR/RhhMygjQ59d9MsNZ4="
      crossorigin="anonymous"
    ></script>
    <script
      src="https://cdn.jsdelivr.net/npm/@hotwired/stimulus@3.0.1/dist/stimulus.umd.js"
      integrity="sha256-t5UIE9c/7eTO5WJEMDEFMlnIQiissc/vDpisFBYiJw4="
      crossorigin="anonymous"
    ></script>
    <script>
      const trackersAnnounceURLs = [
        'wss://tracker.btorrent.xyz',
        'wss://tracker.openwebtorrent.com',
        'wss://tracker.fastcast.nz',
        'wss://tracker.sloppyta.co:443/',
        'wss://tracker.novage.com.ua:443/',
        'wss://spacetradersapi-chatbox.herokuapp.com:443/announce',
        'wss://tracker.files.fm:7073/announce',
      ]

      const pluralize = (count, word, plural = word + 's') =>
        `${count} ${count === 1 ? word : plural}`
      const app = Stimulus.Application.start()
      class PipeController extends Stimulus.Controller {
        static targets = ['status', 'form', 'inbox']
        connect() {
          const channelName = new URLSearchParams(location.search).get('ch')
          const activePeers = new Set()
          const p2pt = new p2pkit.P2PT(
            trackersAnnounceURLs,
            'pipe.spacet.me|' + channelName,
          )

          this.p2pt = p2pt
          this.activePeers = activePeers

          let trackerStats = { connected: 0, total: 0 }
          const updateStats = () => {
            const list =
              activePeers.size > 0
                ? `: ${Array.from(activePeers)
                    .map((p) => p.remoteAddress || String(p.id).slice(0, 8))
                    .join(', ')}`
                : ''
            const message =
              `Connected to ${pluralize(activePeers.size, 'peer')}, ` +
              `discovered through ${trackerStats.connected} / ` +
              `${pluralize(trackerStats.total, 'tracker')} ` +
              `with channel name "${channelName}"` +
              list
            this.statusTarget.innerText = message
          }
          p2pt.on('trackerwarning', (error, stats) => {
            console.warn(error)
            trackerStats = stats
            updateStats()
          })
          p2pt.on('trackerconnect', (tracker, stats) => {
            trackerStats = stats
            updateStats()
          })
          p2pt.on('peerconnect', (peer) => {
            console.log({ peer })
            activePeers.add(peer)
            updateStats()
          })
          p2pt.on('peerclose', (peer) => {
            activePeers.delete(peer)
            updateStats()
          })
          p2pt.on('msg', (peer, message) => {
            if (message.text) {
              const li = document.createElement('li')
              const div = document.createElement('div')
              const remote = peer.remoteAddress || String(peer.id).slice(0, 8)
              div.textContent = `${remote} sent:`
              const textarea = document.createElement('textarea')
              textarea.value = message.text
              textarea.readOnly = true
              li.appendChild(div)
              li.appendChild(textarea)
              this.inboxTarget.insertBefore(li, this.inboxTarget.firstChild)
            }
          })

          updateStats()
          p2pt.start()
        }
        send(e) {
          e.preventDefault()
          const { p2pt, activePeers } = this
          for (const peer of activePeers) {
            p2pt.send(peer, {
              text: this.formTarget.message.value,
            })
          }
        }
      }
      app.register('pipe', PipeController)
    </script>
  </body>
</html>
